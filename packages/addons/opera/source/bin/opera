#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2012 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 51 Franklin Street, Suite 500, Boston, MA 02110, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

### on first run without arguments exec this script
if [ "$1" = "run" ]; then
  # remove 'run' parameter and continue
  shift
else
  exec /storage/.xbmc/addons/web.browser.opera/bin/opera run "$@"
  exit 0
fi

VER_THIS="2"

ADDON_DIR="$HOME/.xbmc/addons/web.browser.opera"
ADDON_HOME="$HOME/.xbmc/userdata/addon_data/web.browser.opera"

### Opera 11 & Flash 10.2
#OPERA_URL_x86_64="ftp://get.opera.com/pub/opera/linux/1162/opera-11.62-1347.x86_64.linux.tar.xz"
#OPERA_URL_i386="ftp://get.opera.com/pub/opera/linux/1162/opera-11.62-1347.i386.linux.tar.xz"
#FLASH_URL_x86_64=""
#FLASH_URL_i386=""

#OPERA_URL_x86_64="http://snapshot.opera.com/unix/retentionrate_12.00-1317/opera-next-12.00-1318.x86_64.linux.tar.xz"
#OPERA_URL_i386="http://snapshot.opera.com/unix/retentionrate_12.00-1317/opera-next-12.00-1317.i386.linux.tar.xz"

OPERA_URL_x86_64="http://snapshot.opera.com/unix/4949_12.00-1360/opera-next-12.00-1362.x86_64.linux.tar.xz"
OPERA_URL_i386="http://snapshot.opera.com/unix/4949_12.00-1360/opera-next-12.00-1360.i386.linux.tar.xz"

FLASH_URL_x86_64="http://fpdownload.macromedia.com/get/flashplayer/pdc/11.1.102.63/install_flash_player_11_linux.x86_64.tar.gz"
FLASH_URL_i386="http://fpdownload.macromedia.com/get/flashplayer/pdc/11.1.102.63/install_flash_player_11_linux.i386.tar.gz"

ADDON_VERSION_FILE="$ADDON_DIR/addon.version"

INSTALL_TMP_OPERA="$ADDON_DIR/install-tmp-opera"
INSTALL_TMP_OPERA_END="/tmp/install-tmp-opera-end"
INSTALL_TMP_OPERA_TEXT="/tmp/install-tmp-opera-text"

DOWNLOADS_OPERA="$ADDON_DIR/download"
FILE_OPERA="$DOWNLOADS_OPERA/opera-next-12.tar.xz"
FILE_FLASH="$DOWNLOADS_OPERA/install_flash_player_11.tar.gz"

LIBDIR="$ADDON_DIR/local"
PROGDIR="$ADDON_DIR/opera12"
PERSONALDIR="$ADDON_HOME/personal"
OPERAICON="/storage/.xbmc/addons/web.browser.opera/icon.png"
LIRC_CONF_FILE="$HOME/.lircrc"
LIRC_CONF_FILE_BAC="$HOME/.lircrc-backup-opera"

LOCKDIR="/var/lock/"
LOCKFILE="xbmc.disabled"
XBMC_LOCKFILE="$LOCKDIR/$LOCKFILE"

CURRENT_RESOLUTION_FILE="/tmp/current-resolution.dat"

export LD_LIBRARY_PATH=$LIBDIR/usr/lib:$LD_LIBRARY_PATH
export PANGO_RC_FILE=$LIBDIR/etc/pango/pangorc
export GDK_PIXBUF_MODULE_FILE=$LIBDIR/etc/gdk_pixbuf-2.0/gdk-pixbuf.loaders

export OPERA_DIR=${OPERA_DIR:-$PROGDIR/share/opera-next}
export LD_LIBRARY_PATH=$PROGDIR/usr/lib:$LD_LIBRARY_PATH
export OPERA_PERSONALDIR=${OPERA_PERSONALDIR:-$PERSONALDIR}

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ADDON_HOME/lib

export PATH=$PATH:$LIBDIR/usr/bin

OPERA_SUCCESS="0"

### exit on errors
set -e

mkdir -p "$ADDON_HOME"
mkdir -p "$ADDON_HOME/plugins"
mkdir -p "$ADDON_HOME/lib"

### check for newer version of this script
if [ -f $ADDON_VERSION_FILE ]; then
  VER_INSTALLED=$(cat $ADDON_VERSION_FILE)
else
  VER_INSTALLED="0"
fi

if [ $VER_THIS -gt $VER_INSTALLED ]; then
  # new version
  rm -fr "$PROGDIR"
  rm -f  "$DOWNLOADS_OPERA"
fi

function osd_msg() {
  if [ -z "$2" ]; then
    xbmc-send -a "Notification(Opera, $1, 2000, $OPERAICON)"
  else
    xbmc-send -a "Notification(Opera, $1, $2, $OPERAICON)"
  fi
}

function progress() {
  echo "$*" >"$INSTALL_TMP_OPERA_TEXT"
}

function trap_exit_install() {
  touch "$INSTALL_TMP_OPERA_END"
  osd_msg "Installation failed!"
  rm -fr "$INSTALL_TMP_OPERA"
  rm -fr "$PROGDIR"
  rm -f "$ADDON_VERSION_FILE"
}

### install if not already
if [ ! -d "$PROGDIR" ]; then
  trap trap_exit_install EXIT

  progress "Installing Opera..."
  chmod +x "$LIBDIR"/usr/bin/*

(
  # don't exit on errors
  set +e

  while true; do
    if [ -f "$INSTALL_TMP_OPERA_END" ]; then
      rm -f "$INSTALL_TMP_OPERA_END"
      break
    fi

    TEXT=$(cat "$INSTALL_TMP_OPERA_TEXT")
    osd_msg "$TEXT"
    sleep 3
  done
)&

  mkdir -p "$INSTALL_TMP_OPERA"
  cd "$INSTALL_TMP_OPERA"

  ARCH=`uname -m`
  if [ "$ARCH" = "x86_64" ]; then
    OPERA_URL="$OPERA_URL_x86_64"
    FLASH_URL="$FLASH_URL_x86_64"
  else
    OPERA_URL="$OPERA_URL_i386"
    FLASH_URL="$FLASH_URL_i386"
  fi

  mkdir -p "$DOWNLOADS_OPERA/"

  if [ ! -f "$FILE_OPERA" ]; then
    progress "Downloading Opera..."
    wget -O "$FILE_OPERA" "$OPERA_URL"
  fi

  if [ ! -f "$FILE_FLASH" ]; then
    progress "Downloading Flash..."
    wget -O "$FILE_FLASH" "$FLASH_URL"
  fi

  xz -d -c "$FILE_OPERA" | tar xf -
  cd opera-next-*
  progress "Installing Opera..."
  sh install --unattended --quiet --prefix "$PROGDIR"
  cd ..

  tar xzf "$FILE_FLASH" libflashplayer.so
  progress "Installing Flash..."
  mkdir -p "$PROGDIR/lib/opera-next/plugins"
  bbe -e "s#/etc/adobe/#/tmp/adobe/#" libflashplayer.so -o "$PROGDIR/lib/opera-next/plugins/libflashplayer.so"

  cd ..
  [ ! -d "$INSTALL_TMP_OPERA" ] && exit
  rm -fr "$INSTALL_TMP_OPERA"

  touch "$INSTALL_TMP_OPERA_END"
  osd_msg "Installation succeeded."
  echo -n "$VER_THIS" > "$ADDON_VERSION_FILE"
fi
### installation end

### application start

function trap_exit_exec() {
  if [ -f $ADDON_HOME/lircrc.conf -a -f $LIRC_CONF_FILE ]; then
    rm -f $LIRC_CONF_FILE

    if [ -f $LIRC_CONF_FILE_BAC ]; then
      mv -f $LIRC_CONF_FILE_BAC $LIRC_CONF_FILE
    fi
  fi

  ### change target resolution back
  if [ "$CHANGE_RESOLUTION" = "true" -a -f "$CURRENT_RESOLUTION_FILE" ]; then
    current_resolution=$(cat $CURRENT_RESOLUTION_FILE)
    rm -f $CURRENT_RESOLUTION_FILE
    if [ -n "$current_resolution" ]; then
      xrandr -s $current_resolution
    fi
  fi

  if [ "$XBMC_KILL" = "true" ]; then
    # start XBMC
    rm -f "$XBMC_LOCKFILE"
  else
    echo .
    xbmc-send -a LIRC.Start
    #killall -CONT xbmc.bin
  fi

  if [ "$OPERA_SUCCESS" = "1" ]; then
    osd_msg "Opera completed."
  else
    osd_msg "Opera failed to start."
  fi

  # script ends
}

trap trap_exit_exec EXIT

cp "$ADDON_DIR"/config/* "$ADDON_HOME/"

if [ ! -f "$ADDON_HOME/lircrc.conf" ]; then
  cp "$ADDON_DIR/config/lircrc.conf.sample" "$ADDON_HOME/lircrc.conf"
fi
if [ ! -f "$ADDON_HOME/mms.cfg" ]; then
  cp "$ADDON_DIR/config/mms.cfg.sample" "$ADDON_HOME/mms.cfg"
fi
if [ ! -f "$ADDON_HOME/settings.xml" ]; then
  cp "$ADDON_DIR/config1/settings.xml" "$ADDON_HOME/settings.xml"
fi

cat "$ADDON_HOME/settings.xml" | awk -F\" '{print $2"=\""$4"\""}' | sed '/^=/d' > /var/config/opera.conf
. /var/config/opera.conf

if [ "$XBMC_KILL" = "true" -a "$XBMC_PAUSE" = "false" ]; then
  XBMC_KILL="true"
else
  XBMC_KILL="false"
fi

if [ -f $ADDON_HOME/lircrc.conf ]; then
  if [ -f $LIRC_CONF_FILE -a ! -f $LIRC_CONF_FILE_BAC ]; then
    cp -f $LIRC_CONF_FILE $LIRC_CONF_FILE_BAC
  fi

  cp $ADDON_HOME/lircrc.conf $LIRC_CONF_FILE
fi

if [ ! -f $PERSONALDIR/pluginpath.ini -a -f $ADDON_DIR/config1/pluginpath.ini ]; then
  mkdir -p $PERSONALDIR/
  cp $ADDON_DIR/config1/pluginpath.ini $PERSONALDIR/
fi

OPERA_START_URL=""
if [ ! -f $PERSONALDIR/operaprefs.ini -a -f $ADDON_DIR/config1/operaprefs.ini ]; then
  mkdir -p $PERSONALDIR/
  cp $ADDON_DIR/config1/operaprefs.ini $PERSONALDIR/
  OPERA_START_URL="-activetab http://openelec.tv/"
fi

rm -fr /tmp/adobe/
if [ -f $ADDON_HOME/mms.cfg ]; then
  mkdir -p /tmp/adobe/
  cp $ADDON_HOME/mms.cfg /tmp/adobe/
fi

### put window on whole screen
if [ "$WINDOW_ACTIVATE" = "true" ]; then
(
  set +e

  OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  while [ "$OPERAID" = "" ]; do
    usleep 500000
    OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  done

  ### just to be safe
  sleep 1

  xdotool windowminimize $OPERAID
  xdotool windowraise $OPERAID
)&
fi

### change target resolution
if [ "$CHANGE_RESOLUTION" = "true" ]; then
(
  set +e

  OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  while [ "$OPERAID" = "" ]; do
    usleep 500000
    OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  done

  ### just to be safe
  sleep 1

  current_resolution=`xrandr 2>/dev/null | awk '/default connected/ {split($3,a,"+"); printf("%s",a[1])}'`
  echo "$current_resolution" >$CURRENT_RESOLUTION_FILE
  xrandr -s 1280x720
  #xrandr -s 720x576
)&
fi

wingravity=$(ratpoison -c "set wingravity")
if [ "$wingravity" = "Unknown" ]; then
  ratpoison -c "set wingravity northwest"
  ratpoison -c "set transgravity northwest"
  ratpoison -c "set maxsizegravity northwest"
fi

if [ "$OVERSCAN_ENABLE" = "true" ]; then
  ### must be done only once
  padding=$(ratpoison -c "set padding")
  if [ "$padding" = "0 0 0 0" ]; then
    ratpoison -c "set padding $PADDING_LEFT $PADDING_TOP $PADDING_RIGHT $PADDING_BOTTOM"
  fi
fi

osd_msg "Starting..."

if [ "$XBMC_KILL" = "true" ]; then
  touch "$XBMC_LOCKFILE"
  [ "$(pidof xbmc.bin)" ] && killall -9 xbmc.bin
else
  echo .
  xbmc-send -a LIRC.Stop
  #killall -STOP xbmc.bin
fi

$PROGDIR/lib/opera-next/opera-next "$@" $OPERA_START_URL

OPERA_SUCCESS="1"

### run exit stuff
exit
