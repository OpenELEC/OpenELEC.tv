#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2012 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 51 Franklin Street, Suite 500, Boston, MA 02110, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

################################################################################
OPERA_URL_x86_64="http://get.geo.opera.com/pub/opera/linux/1200/opera-12.00-1467.x86_64.linux.tar.bz2"
OPERA_URL_i386="http://get.geo.opera.com/pub/opera/linux/1200/opera-12.00-1467.i386.linux.tar.bz2"

FLASH_URL_x86_64="http://fpdownload.macromedia.com/get/flashplayer/pdc/11.2.202.236/install_flash_player_11_linux.x86_64.tar.gz"
FLASH_URL_i386="http://fpdownload.macromedia.com/get/flashplayer/pdc/11.2.202.236/install_flash_player_11_linux.i386.tar.gz"

DROPBOX_LIBRARIES="http://dl.dropbox.com/u/8224157/OpenELEC-Ultra/opera/final/libraries"
EXTRA_URL="http://dl.dropbox.com/u/8224157/OpenELEC-Ultra/opera/final/extra.zip"

################################################################################

VER_THIS="3"

ADDON_DIR="$HOME/.xbmc/addons/web.browser.opera"
ADDON_HOME="$HOME/.xbmc/userdata/addon_data/web.browser.opera"

STORAGE_FONTS="/storage/.fonts"

ADDON_VERSION_FILE="$ADDON_DIR/addon.version"

INSTALL_TMP_OPERA="$ADDON_DIR/install-tmp-opera"
INSTALL_TMP_OPERA_END="/tmp/install-tmp-opera-end"
INSTALL_TMP_OPERA_TEXT="/tmp/install-tmp-opera-text"

DOWNLOADS_OPERA="$ADDON_DIR/download"
FILE_OPERA="$DOWNLOADS_OPERA/opera-12.tar.bz2"
FILE_FLASH="$DOWNLOADS_OPERA/flash_11.tar.gz"
FILE_LIBRRAIES="$DOWNLOADS_OPERA/libraries.zip"
FILE_EXTRA="$DOWNLOADS_OPERA/extra.zip"

LIBDIR="$ADDON_DIR/local"
PROGDIR="$ADDON_DIR/opera12"
PERSONALDIR="$ADDON_HOME/personal"
OPERAICON="/storage/.xbmc/addons/web.browser.opera/icon.png"
LIRC_CONF_FILE="$HOME/.lircrc"
LIRC_CONF_FILE_BAC="$HOME/.lircrc-backup-opera"

LOCKDIR="/var/lock/"
LOCKFILE="xbmc.disabled"
XBMC_LOCKFILE="$LOCKDIR/$LOCKFILE"

CURRENT_RESOLUTION_FILE="/tmp/current-resolution.dat"

LIBFLASHPLAYER_SO="$ADDON_HOME/plugins/libflashplayer.so"

### Adobe Flash player works more stable?
if [ -f "$LIBDIR/usr/lib/libgtk-x11-2.0.so.0" ]; then
	export LD_PRELOAD=$LIBDIR/usr/lib/libgtk-x11-2.0.so.0
fi

export PANGO_RC_FILE=$LIBDIR/etc/pango/pangorc
export GDK_PIXBUF_MODULE_FILE=$LIBDIR/etc/gdk_pixbuf-2.0/gdk-pixbuf.loaders

export OPERA_DIR=${OPERA_DIR:-$PROGDIR/share/opera}
export OPERA_PERSONALDIR=${OPERA_PERSONALDIR:-$PERSONALDIR}

export PATH=$PATH:$LIBDIR/usr/bin
export LD_LIBRARY_PATH=$LIBDIR/usr/lib:$ADDON_HOME/lib

OPERA_SUCCESS="0"

### exit on errors
set -e

mkdir -p "$ADDON_HOME"
mkdir -p "$ADDON_HOME/plugins"
mkdir -p "$ADDON_HOME/lib"

### check for newer version of this script
if [ -f $ADDON_VERSION_FILE ]; then
  VER_INSTALLED=$(cat $ADDON_VERSION_FILE)
else
  VER_INSTALLED="0"
fi

if [ $VER_THIS -gt $VER_INSTALLED ]; then
  # new version
  rm -fr "$PROGDIR"
  rm -fr "$DOWNLOADS_OPERA"
fi

osd_msg() {
  if [ -z "$2" ]; then
    xbmc-send -a "Notification(Opera, $1, 2000, $OPERAICON)"
  else
    xbmc-send -a "Notification(Opera, $1, $2, $OPERAICON)"
  fi
}

progress() {
  echo "$*" >"$INSTALL_TMP_OPERA_TEXT"
}

trap_exit_install() {
  touch "$INSTALL_TMP_OPERA_END"
  osd_msg "Installation failed!"
  rm -fr "$INSTALL_TMP_OPERA"
  rm -fr "$PROGDIR"
  rm -f "$ADDON_VERSION_FILE"
}

### install if not already
if [ ! -d "$PROGDIR" ]; then
  trap trap_exit_install EXIT

  progress "Start installing Opera addon..."

(
  # don't exit on errors
  set +e

  while true; do
    if [ -f "$INSTALL_TMP_OPERA_END" ]; then
      rm -f "$INSTALL_TMP_OPERA_END"
      break
    fi

    TEXT=$(cat "$INSTALL_TMP_OPERA_TEXT")
    osd_msg "$TEXT"
    sleep 3
  done
)&

  mkdir -p "$INSTALL_TMP_OPERA"
  cd "$INSTALL_TMP_OPERA"

  ARCH=`uname -m`
  if [ "$ARCH" = "x86_64" ]; then
    OPERA_URL="$OPERA_URL_x86_64"
    FLASH_URL="$FLASH_URL_x86_64"
  else
    OPERA_URL="$OPERA_URL_i386"
    FLASH_URL="$FLASH_URL_i386"
  fi

  OE_NAME=$(cat /etc/release | awk 'BEGIN {FS="-" } {printf("%s",$1)}')
  OE_VER=$(cat /etc/release | awk 'BEGIN {FS="-" } {printf("%s",$2)}')
  LIBRARIES_URL=$DROPBOX_LIBRARIES/libraries-$OE_NAME-$OE_VER.zip

  mkdir -p "$DOWNLOADS_OPERA/"

  if [ ! -f "$FILE_OPERA" ]; then
    progress "Downloading Opera archive..."
    wget -O "$FILE_OPERA" "$OPERA_URL"
  fi

  if [ ! -f "$FILE_FLASH" ]; then
    progress "Downloading Flash archive..."
    wget -O "$FILE_FLASH" "$FLASH_URL"
  fi

  if [ ! -f "$FILE_LIBRRAIES" ]; then
    progress "Downloading libraries archive..."
    wget -O "$FILE_LIBRRAIES" "$LIBRARIES_URL"
  fi

  if [ ! -f "$FILE_EXTRA" ]; then
    progress "Downloading extra stuff..."
    wget -O "$FILE_EXTRA" "$EXTRA_URL"
  fi

  progress "Unpacking Opera archive..."
  tar xjf "$FILE_OPERA"
  cd opera-12*
  progress "Installing Opera..."
  sh install --unattended --quiet --prefix "$PROGDIR"
  rm -f "$PROGDIR/bin/opera"
  cd ..

  progress "Unpacking Flash archive..."
  tar xzf "$FILE_FLASH" -C "$ADDON_HOME/plugins/" libflashplayer.so

  progress "Unpacking libraries archive..."
  unzip "$FILE_LIBRRAIES" -d "$ADDON_DIR"
  chmod +x "$LIBDIR"/usr/bin/*

  progress "Unpacking extra stuff..."
  unzip "$FILE_EXTRA" -d "$ADDON_DIR"
  
  ### my personal config - or even beter: buy new TV and delete this lines :-)
  if [ -f /storage/.config/edid.bin.ultra2.TX-SR508 ]; then
    sed -i 's|<setting id="OVERSCAN_ENABLE" value="false" />|<setting id="OVERSCAN_ENABLE" value="true" />|' $ADDON_DIR/config1/settings.xml
  fi

  cd ..
  [ ! -d "$INSTALL_TMP_OPERA" ] && exit
  rm -fr "$INSTALL_TMP_OPERA"

  touch "$INSTALL_TMP_OPERA_END"
  osd_msg "Installation succeeded."
  echo -n "$VER_THIS" > "$ADDON_VERSION_FILE"

  ### to install same version again from changed zip file
  rm -f /storage/.xbmc/addons/packages/web.browser.opera-*
fi
### installation end

### application start

trap_exit_exec() {
  if [ -f $ADDON_HOME/lircrc.conf -a -f $LIRC_CONF_FILE ]; then
    rm -f $LIRC_CONF_FILE

    if [ -f $LIRC_CONF_FILE_BAC ]; then
      mv -f $LIRC_CONF_FILE_BAC $LIRC_CONF_FILE
    fi
  fi

  ### change target resolution back
  if [ "$CHANGE_RESOLUTION" = "true" -a -f "$CURRENT_RESOLUTION_FILE" ]; then
    current_resolution=$(cat $CURRENT_RESOLUTION_FILE)
    rm -f $CURRENT_RESOLUTION_FILE
    if [ -n "$current_resolution" ]; then
      xrandr -s $current_resolution
    fi
  fi

  if [ "$XBMC_KILL" = "true" ]; then
    # start XBMC
    rm -f "$XBMC_LOCKFILE"
  else
    echo .
    xbmc-send -a LIRC.Start
    #killall -CONT xbmc.bin
  fi

  # enable navigation sounds
  xbmc-send -a "RunScript(/storage/.xbmc/addons/web.browser.opera/bin/navsounds-toggle.py, True)"

  if [ "$OPERA_SUCCESS" = "1" ]; then
    osd_msg "Opera completed."
  else
    osd_msg "Opera failed to start."
  fi

  # script ends here
}

trap trap_exit_exec EXIT

cp "$ADDON_DIR"/config/* "$ADDON_HOME/"

if [ ! -f "$ADDON_HOME/lircrc.conf" ]; then
  cp "$ADDON_DIR/config/lircrc.conf.sample" "$ADDON_HOME/lircrc.conf"
fi
if [ ! -f "$ADDON_HOME/settings.xml" ]; then
  cp "$ADDON_DIR/config1/settings.xml" "$ADDON_HOME/settings.xml"
fi

cat "$ADDON_HOME/settings.xml" | awk -F\" '{print $2"=\""$4"\""}' | sed '/^=/d' > /var/config/opera.conf
. /var/config/opera.conf

if [ "$XBMC_KILL" = "true" -a "$XBMC_PAUSE" = "false" ]; then
  XBMC_KILL="true"
else
  XBMC_KILL="false"
fi

if [ -f $ADDON_HOME/lircrc.conf ]; then
  if [ -f $LIRC_CONF_FILE -a ! -f $LIRC_CONF_FILE_BAC ]; then
    cp -f $LIRC_CONF_FILE $LIRC_CONF_FILE_BAC
  fi

  cp $ADDON_HOME/lircrc.conf $LIRC_CONF_FILE
fi

if [ ! -f $PERSONALDIR/pluginpath.ini -a -f $ADDON_DIR/config1/pluginpath.ini ]; then
  mkdir -p $PERSONALDIR/
  cp $ADDON_DIR/config1/pluginpath.ini $PERSONALDIR/
fi

OPERA_START_URL=""
if [ ! -f $PERSONALDIR/operaprefs.ini -a -f $ADDON_DIR/config1/operaprefs.ini ]; then
  mkdir -p $PERSONALDIR/
  cp $ADDON_DIR/config1/operaprefs.ini $PERSONALDIR/
  OPERA_START_URL="-activetab http://openelec.tv/"

  tar xjf $ADDON_DIR/extra/adblock.tbz2 -C $PERSONALDIR/

  mkdir -p "$STORAGE_FONTS"
  tar xjf $ADDON_DIR/extra/fonts.tbz2 -C "$STORAGE_FONTS"
fi

### put window on whole screen
if [ "$WINDOW_ACTIVATE" = "true" ]; then
(
  set +e

  OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  while [ "$OPERAID" = "" ]; do
    usleep 500000
    OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  done

  ### just to be safe
  sleep 1

  xdotool windowminimize $OPERAID
  xdotool windowraise $OPERAID
)&
fi

### change target resolution
if [ "$CHANGE_RESOLUTION" = "true" ]; then
(
  set +e

  OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  while [ "$OPERAID" = "" ]; do
    usleep 500000
    OPERAID=$(xdotool search --name '\- Opera Next$' 2>/dev/null)
  done

  ### just to be safe
  sleep 1

  current_resolution=`xrandr 2>/dev/null | awk '/default connected/ {split($3,a,"+"); printf("%s",a[1])}'`
  echo "$current_resolution" >$CURRENT_RESOLUTION_FILE
  xrandr -s 1280x720
  #xrandr -s 720x576
)&
fi

wingravity=$(ratpoison -c "set wingravity")
if [ "$wingravity" = "Unknown" ]; then
  ratpoison -c "set wingravity northwest"
  ratpoison -c "set transgravity northwest"
  ratpoison -c "set maxsizegravity northwest"
fi

if [ "$OVERSCAN_ENABLE" = "true" ]; then
  ### must be done only once
  padding=$(ratpoison -c "set padding")
  if [ "$padding" = "0 0 0 0" ]; then
    ratpoison -c "set padding $PADDING_LEFT $PADDING_TOP $PADDING_RIGHT $PADDING_BOTTOM"
  fi
fi

osd_msg "Starting..."

if [ "$XBMC_KILL" = "true" ]; then
  touch "$XBMC_LOCKFILE"
  [ "$(pidof xbmc.bin)" ] && killall -9 xbmc.bin
else
  echo .
  xbmc-send -a LIRC.Stop
  #killall -STOP xbmc.bin
fi

# Flash acceleration
rm -fr /tmp/adobe/
if [ "$FLASH_ACCELERATION" = "true" ]; then
  if [ ! -f "$ADDON_HOME/plugins/accelerated.flash" ];then
    touch "$ADDON_HOME/plugins/accelerated.flash"
    bbe -e "s#/etc/adobe/#/tmp/adobe/#" "$LIBFLASHPLAYER_SO" -o "$ADDON_HOME/plugins/flash.tmp"
    mv "$ADDON_HOME/plugins/flash.tmp" "$LIBFLASHPLAYER_SO"
  fi

  mkdir -p /tmp/adobe/
  echo -e "EnableLinuxHWVideoDecode=1\nOverrideGPUValidation=true" >/tmp/adobe/mms.cfg
else
  if [ -f "$ADDON_HOME/plugins/accelerated.flash" ];then
    rm -f "$ADDON_HOME/plugins/accelerated.flash"
    bbe -e "s#/tmp/adobe/#/etc/adobe/#" "$LIBFLASHPLAYER_SO" -o "$ADDON_HOME/plugins/flash.tmp"
     mv "$ADDON_HOME/plugins/flash.tmp" "$LIBFLASHPLAYER_SO"
  fi
fi

# disable navigation sounds
xbmc-send -a "RunScript(/storage/.xbmc/addons/web.browser.opera/bin/navsounds-toggle.py, False)"

$PROGDIR/lib/opera/opera "$@" $OPERA_START_URL

OPERA_SUCCESS="1"

### run exit stuff
exit
