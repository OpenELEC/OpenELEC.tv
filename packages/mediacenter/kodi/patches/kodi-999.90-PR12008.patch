From f35298ec0a9e5dfbd38a7a64f3b5eb3bb3c219af Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Mon, 24 Apr 2017 20:05:07 +0200
Subject: [PATCH] AESinkPULSE: Return to PA's delay infrastructure

---
 xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp | 27 +++++----------------------
 xbmc/cores/AudioEngine/Sinks/AESinkPULSE.h   |  2 --
 2 files changed, 5 insertions(+), 24 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
index 5b86767..718a497 100644
--- a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
@@ -22,7 +22,6 @@
 #include "AESinkPULSE.h"
 #include "utils/log.h"
 #include "Util.h"
-#include "utils/TimeUtils.h"
 #include "guilib/LocalizeStrings.h"
 #include "Application.h"
 #include "cores/AudioEngine/Engines/ActiveAE/ActiveAE.h"
@@ -486,8 +485,6 @@ CAESinkPULSE::CAESinkPULSE()
   m_MainLoop = NULL;
   m_BytesPerSecond = 0;
   m_BufferSize = 0;
-  m_filled_bytes = 0;
-  m_lastPackageStamp = 0;
   m_Channels = 0;
   m_Stream = NULL;
   m_Context = NULL;
@@ -511,8 +508,6 @@ bool CAESinkPULSE::Initialize(AEAudioFormat &format, std::string &device)
   m_passthrough = false;
   m_BytesPerSecond = 0;
   m_BufferSize = 0;
-  m_filled_bytes = 0;
-  m_lastPackageStamp = 0;
   m_Channels = 0;
   m_Stream = NULL;
   m_Context = NULL;
@@ -790,8 +785,6 @@ void CAESinkPULSE::Deinitialize()
   m_IsAllocated = false;
   m_passthrough = false;
   m_periodSize = 0;
-  m_filled_bytes = 0;
-  m_lastPackageStamp = 0;
 
   if (m_Stream)
     Drain();
@@ -833,22 +826,14 @@ void CAESinkPULSE::GetDelay(AEDelayStatus& status)
   }
 
   pa_threaded_mainloop_lock(m_MainLoop);
-  const pa_timing_info* pti = pa_stream_get_timing_info(m_Stream);
-  // only incorporate local sink delay + internal PA transport delay
-  double sink_delay = (pti->configured_sink_usec / 1000000.0);
-  double transport_delay = pti->transport_usec / 1000000.0;
+  pa_usec_t r_usec;
+  int negative;
 
-  uint64_t diff = CurrentHostCounter() - m_lastPackageStamp;
-  unsigned int bytes_played = (unsigned int) ((double) diff * (double) m_BytesPerSecond  / (double) CurrentHostFrequency() + 0.5);
-
-  int buffer_delay = m_filled_bytes - bytes_played;
-  if (buffer_delay < 0)
-    buffer_delay = 0;
+  if (pa_stream_get_latency(m_Stream, &r_usec, &negative) < 0)
+    r_usec = 0;
 
   pa_threaded_mainloop_unlock(m_MainLoop);
-
-  double delay = buffer_delay / (double) m_BytesPerSecond + sink_delay + transport_delay;
-  status.SetDelay(delay);
+  status.SetDelay(r_usec / 1000000.0);
 }
 
 double CAESinkPULSE::GetCacheTotal()
@@ -886,8 +871,6 @@ unsigned int CAESinkPULSE::AddPackets(uint8_t **data, unsigned int frames, unsig
     CLog::Log(LOGERROR, "CPulseAudioDirectSound::AddPackets - pa_stream_write failed\n");
     return 0;
   }
-  m_lastPackageStamp = CurrentHostCounter();
-  m_filled_bytes = m_BufferSize - (free - length);
   unsigned int res = (unsigned int)(length / m_format.m_frameSize);
 
   return res;
diff --git a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.h b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.h
index ac0525f..0bdf5d2 100644
--- a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.h
+++ b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.h
@@ -70,8 +70,6 @@ class CAESinkPULSE : public IAESink
   pa_cvolume m_Volume;
   bool m_volume_needs_update;
   uint32_t m_periodSize;
-  uint64_t m_lastPackageStamp;
-  uint64_t m_filled_bytes;
 
   pa_context *m_Context;
   pa_threaded_mainloop *m_MainLoop;
